# Проект создания прогностической модели для выявления и мониторинга рецидивов при лейкозах

**Лейкоз** (рак крови) — это злокачественное гематологическое заболевание, при котором наблюдаются аномалии в количестве и структуре лейкоцитов. Аномальные лейкоциты не могут выполнять свою главную задачу — защищать организм от инфекций. Лейкозы классифицируют в соответствии со скоростью прогрессирования. Острый лейкоз – это быстро растущая разновидность лейкоза, и он распространяется по телу за несколько недель или месяцев. В противоположность ему, хронический лейкоз растет медленно, и его симптомы прогрессируют в течение нескольких лет (https://netoncology.ru/about_cancer/tipy_leykozov_i_mekhanizmy_razvitiya/). При лейкозе опухолевая ткань первоначально разрастается в месте локализации костного мозга и постепенно замещает нормальные ростки кроветворения. В результате этого процесса у больных лейкозом закономерно развиваются различные варианты цитопений — **анемия**, тромбоцитопения, лимфоцитопения, гранулоцитопения, что приводит к повышенной кровоточивости, кровоизлияниям, подавлению иммунитета с присоединением инфекционных осложнений (https://ru.wikipedia.org/wiki/%D0%9B%D0%B5%D0%B9%D0%BA%D0%BE%D0%B7). 

<img width="1500" height="990" alt="image" src="https://github.com/user-attachments/assets/fe2a063f-a731-47ec-b861-036c32948b6e" />
(Источник:https://www.verywellhealth.com/leukemia-causes-risk-factors-2252385)


Заболеваемость лейкозами за последние годы стабилизировалась, в некоторых же странах наблюдается ее небольшой рост. Выраженное снижение смертности отмечается для детских лейкозов. Смертность от лейкозов снижается и у взрослых, однако эта тенденция снижения среди взрослых значительно скромнее, чем у детей. Смертность от лейкозов растет среди пожилых людей. Лимфоидный лейкоз составляет около 50%, а миелоидные – 43% всех форм лейкозов. Около 2% составляют моноцитарный и волосатоклеточный лейкоз. Основными доказанными факторами риска лейкозов, которые классифицированы МАИР как канцерогенные для человека, являются ионизирующее излучение, контакт на производстве с бензолом и другими растворителями и курение. Кроме того, риск возникновения лейкозов достоверно повышен у рабочих, занятых на производстве резины и обуви. Резиновая и обувная промышленность отнесена МАИР к 1 группе факторов, канцерогенность которых для человека доказана. Важную роль в этиологии лейкозов, скорее всего, играют онкогенные вирусы (https://oncology.ru/specialist/epidemiology/malignant/C91/). Согласно официальной статистике, в России диагностируется порядка 8 тысяч заболевших лейкозом в год. Цифра сопоставима с данными в других странах.

Схема лечения лейкоза часто составляется и назначается каждому пациенту индивидуально. Обычно существует пять основных подходов в лечении лейкоза (https://netoncology.ru/old/patient/diagnostics/1305/2167/2185/): 

Химиотерапия - чтобы уничтожить клетки лейкоза применением цитотоксических препаратов;

Терапия интерфероном, чтобы замедлить репродукцию клеток лейкоза и активизировать деятельность иммунной системы по борьбе с лейкозом;

Лучевая терапия, чтобы уничтожить раковые клетки методом облучения высокой дозы;

Трансплантация стволовых клеток (ТСК), чтобы облегчить лечение высокими дозами химиотерапии и лучевой терапии;

Хирургическое лечение, чтобы удалить увеличенную селезенку или установить устройство для венозного доступа для поступления лекарственных препаратов и получения образцов крови.

Для острых и хронических форм лейкозов очень важна не только первичная диагностика, но и отслеживание маркеров и рецидива (возвращения заболевания). Существуют геномные мутации, которые существенно увеличивают риск рецидива или снижают эффективность терапии. Как правило, пациентам с подобными генетическими предрасположенностями назначают регулярные анализы, включающие отслеживание молеклярных маркеров. 

Клинический анализ крови является одним из первых и наиболее доступных развернутых диагностических анализов, который назначают врачи общей практики при обращении пациента в медицинское учереждение с жалобами на самочувствие. Клинический анализ крови при лейкозах выявляет характерные изменения, позволяющие заподозрить и подтвердить диагноз, а также оценить стадию и динамику заболевания. 

Компьютерные технологии стремительно развиваются в различных сферах человеческой жизни, включая здравоохранение. С развитием вычислительных ресурсов работа с большими данными (big data) стала значительно проще. Современная медицина же способствует созданию больших баз данных по пациентам с различными заболеваниями, с помощью которых можно выявлять причинно-следственные связи и разрабатывать предсказательные модели (Chang et al., 2022). 
<img width="1776" height="1779" alt="image" src="https://github.com/user-attachments/assets/b3c19ea5-1672-4faf-89f6-4d2fe236241b" />
(Источник:https://www.mdpi.com/2227-7390/9/22/2970)

В нашем исследовании мы использовали выгрузку данных с клиническим анализом крови для пациентов с лейкозами. https://lms.skillfactory.ru/asset-v1:Skillfactory+DSMED+2023+type@asset+block@undefind_DSMED.csv
После тщательного разведовательного анализа были выявлены записи из 241 медицинских карт, для многих пациентов присутствовало по несколько записей с различными результатами анализов. В связи с тем, что у нас не была размечена шкала времени сдачи анализа для пациентов, мы не смогли провести анализ динамики показателей крови. Тем не менее, полагаясь на литературные данные по лейкозам, мы решили разделить пациентов на группы риска. Именно по уровню риска была обучена модель, позволяющая предсказать с высокой чувствительностью подозрения в патологическом процессе у пациента (диагностирование заболевания/рецидива). В Среднюю группу риска были относены пациенты с хроническими лейкозами (как миелоидным, так и лимфоцитарным), а в Высокую группу риска - с острыми формами. Острые формы характеризауются повышенной агрессивностью, поэтому таких пациентов нужно дообследовать в кратчайшие сроки. Модель была разработана в формате пользовательского интерфейса, в который пациент может подгружать свои результаты клинического анализа крови и  получать на их основании информацию о рисках и необходимости срочного обращения за медицинской помощью. Также этот интерфейс может быть использован врачами общей практики для скринингового выявления пула населения с рисками к развитию лейкозов. Модель была разработана для взрослого населения, тем не менее, при наличии дополнительных данных из баз с медицинскими анализами, интерфейс может быть расширен и на детское население.


# Подробный разбор кода и процессов
1. Исходные данные и первые шаги.
   
– Загружается CSV‑файл undefind_DSMED.csv (≈36 тыс. строк) с 13 столбцами, в основном это ID пациента, диагноз, пол, дата рождения и различные лабораторные показатели.

– Данные копируются в blood_copy, выводятся первые 50 строк и различные статистики (head(), value_counts(), info(), describe()). Это нужно для первичного знакомства и понимания распределений.

– Столбец «Пол» переводится в числа (0 для мужчин, 1 для женщин), а из даты рождения вычисляется «Возраст» в годах.

2. Унификация названий лабораторных показателей.
   
– Создаётся большой словарь dict_lab с соответствием разных написаний одного и того же показателя (например, «Лейкоциты», «WBC», «Общее количество лейкоцитов» → «Лейкоциты»).

– Для каждого значения столбца Кол. лаб. показатель вызывается функция change_lab_name, которая заменяет его на стандартное название. Это обеспечивает единообразие при дальнейшем анализе.

– Затем строится сводная таблица (pivot_table), где каждая строка — это уникальный пациент с диагнозом, полом и возрастом, а каждый лабораторный показатель разворачивается в отдельные столбцы: Значение кол. показателя_<название>, Норма кол. показателя_<название>, Ед. изм. кол. показателя_<название>, Флаг нормы кол. показателя_<название>.

3. Нормализация категориальных значений.
   
– Создаётся функция normalize_column_values, которая приводит текстовые поля «норма/повышено/понижено» к стандартным кодам (Норм, Повыш, Пониж, nan). Пропуски и лишние символы тоже переводятся в 'nan'.

– Таблица df после нормализации сохраняется в df_norm, для каждого столбца собирается список уникальных значений, который записывается в Excel‑файл unique_values_by_column_norm.xlsx.

4. Очистка и преобразование количественных данных.
   
– Для гистограмм используются seaborn.histplot по каждому числовому столбцу.

– Столбец «Средняя концентрация гемоглобина в эритроците» переводится в г/дл: если значение меньше 100, то умножается на 10. Это предотвращает смешение единиц измерения.

– Строится корреляционная матрица, чтобы понять взаимосвязи между количественными признаками.

– Столбцы, где доля заполненных значений < 70 %, удаляются (список cols_for_delete). 

– Создаётся категориальный признак «Возраст_кат» (дети, молодые, взрослые, пожилые) на основе возраста.

– Пропущенные значения в количественных признаках заполняются медианой внутри групп, сформированных по полу, возрастной категории и диагнозу (groupby + transform('median')). Такое локальное заполнение учитывает биологические различия.

5. Формирование групп риска и балансировка.
    
– Определяется список диагнозов среднего риска: «Хронический миелоидный лейкоз», «Хронический лимфоцитарный лейкоз», «Волосатоклеточный лейкоз». Всё остальное — «Высокий» риск.

– Данные делятся на две подвыборки (высокий и средний риск). Чтобы устранить дисбаланс (среднего риска меньше), использется функция resample - берёт пациентов среднего риска и случайно дублирует некоторых из них.  (Также был протестирвоан подход по устранению дисбаланса для группы среднего риска с применением дублирования и добавления шума в данные. Подвыборка среднего риска расширялась дублированием строк с заменой (sample(..., replace=True)), после чего к этим строкам добавляли шум: возраст смещали на нормальное распределение с σ = 2, а количественные показатели умножали на случайный коэффициент 0.75–1.25, затем строили гистограммы для столбцов после добавления шума. Это достаточно рискованное решение - с одной стороны действительно снижается вероятность переобучения, с другой - мы теряем все внутренние взаимозависимости признаков и клиническую релевантность. С кодом для этого решения можно ознакомиться в файле leukemia_raw_models.ipynb).

6. Синтетические «здоровые» пациенты.
    
– Из «Норма кол. показателя_<...>», где значение хранится как строка «min:max», вычисляются средние границы нормы (convert_norm_to_min_max). Например, для гемоглобина берутся средние min и max среди всех пациентов.

– Используется функция generate_normal_value для генерации случайного значения внутри этих границ. Создаётся DataFrame со 200 вымышленными пациентами (generate_healthy_patients). Им ставится диагноз «Здоров», возраст случайный 10–99, пол 0/1, и все показатели генерируются внутри нормативных диапазонов. Им присваивается риск «Низкий».

– Эти синтетические данные объединяются с балансированной выборкой в df_final.


7. Предварительная обработка перед моделированием.
    
– Категориальные столбцы «Осн. диаг. при выписке МКБ10 (текст)_» и «Возраст_кат» кодируются с помощью LabelEncoder.

– Целевой признак «Риск» кодируется вручную: Низкий → 0, Средний → 1, Высокий → 2.

– Пропуски в X заполняются медианой (SimpleImputer(strategy='median')).

– Фичи стандартизируются (StandardScaler) и разбиваются на train/test в пропорции 70/30 с сохранением пропорций классов (stratify=y).


8. Построение нейросетевой модели.
    
– Используется Sequential‑модель Keras: входной слой 256 нейронов с relu и L1/L2‑регуляризацией (λ=0.005/0.02), затем BatchNormalization, затем Dropout(0.55), затем скрытый слой на 128 нейронов, и выходной слой на 3 нейрона (softmax).
<img width="793" height="366" alt="image" src="https://github.com/user-attachments/assets/fe4d7df0-d8d3-4227-9429-53669ec7d968" />

– Оптимизатор Adam с lr=0.001, функция потерь sparse_categorical_crossentropy, метрики — accuracy и собственная recall_m (переиспользование Recall для многоуровневого класса).

– Cеть автоматически прекращает обучение при начале переобучения; веса классов дополнительно сбалансированы.

– Модель обучается 20 эпох с validation_split=0.2.

– После обучения выводят графики изменения точности, recall и loss на обучении и валидации.

– На тестовой выборке прогнозируются вероятности и классы; считаются accuracy и recall (macro). Строится матрица ошибок (confusion_matrix).

– Модель сохраняется в leukemia_model.keras.

– Финальная модель показывает следующие метрики на валидационных данных: Accuracy: 0.9774, Recall: 0.9853.

В рамках разработки подходов к моделированию были также протестирован подход с уменьшением размероности данных методом главных компонент (PCA), а также были протестированы: модель случайного леса (Random Forest Classifier) с оптимизацией гиперпараметров Optuna с и без PCA, модель категориального бустинга (CatBoost) с и без PCA, нейросетевая модель tensorflow с и без PCA. Наилучшие результаты на ML моделях показали данные с уменьшенными размерностями (с PCA), без уменьшения размерности наблюдалось переобучение (overfitting) во всех случаях. Также был показан вклад каждого из параметров в предсказание модели. Уровни важности признаков и их соответствующий вклад в предсказания моделей сопоставим с литературными данными о важности признаков в патогенезе лейкозов:
<img width="989" height="1289" alt="image" src="https://github.com/user-attachments/assets/030809a2-f55a-46ef-b458-4efd8c4a3bc7" />


9. Пример сервиса для развертывания.
    
– Подключается ray[serve], определяется класс LeukemiaModel со Starlette‑совместимым интерфейсом, который загружает сохранённую модель и принимает JSON с массивом признаков, делая прогноз и возвращая результаты. С примером пользовательского интерфейса можно ознакомиться по ссылке: https://huggingface.co/spaces/AJinn1/Leukemia_hackaton


10. Дополнительный скрипт классификации анемии.
    
– Определяется функция classify_anemia, которая, исходя из пола и лабораторных показателей гемоглобина (Hb), MCH, MCV и MCHC, определяет наличие и тип анемии: железодефицитная (микроцитарная гипохромная), мегалобластная, анемия при опухолевых заболеваниях или хронических заболеваниях.

– Для каждого пациента вычисляется степень тяжести (легкая/средняя/тяжелая) и тип анемии; результат записывается в столбец Тип_анемии.


11. Идеи для дальнейшего улучшения.
    
– Для расширения функционала, модель может быть дополнена модулем обработки изображений (моделью компьютерного зрения), который будет распознавать сканы справок и трансформировать их в табличные данные с анализами.

– Модель может быть дополнена модулем обработки естественного языка (рекуррентной моделью), который позволит анализировать комментарии врачей в справках с анализами.

– Можно добавить многоклассовую классификацию в модель для установления точного диагноза конкретного типа лейкоза. Для этого потребуется большая база данных анализов крови с хорошей представленностью соотвествующих типов лейкозов.


**ВНИМАНИЕ!**
Данная предсказательная модель разработана в рамках учебной задачи и не может быть использована для постановки диагноза пациенту. Модель требует оптимизации и множественных апробаций на реальных данных электронных медицинских карт и анализов пациентов.

**Команда авторов и контакты**

Анастасия Чухонцева, врач-педиатр (GitHub: AsnastasiiaChukhontseva, email:asenka2503@gmail.com)

Максим Ушаков, врач (GitHub: AJinn1, email:)

Татьяна Ермакова, врач-педиатр (GitHub: Tatianaremak, email: )

Анастасия Шнырева, к.б.н., биолог, молекулярный генетик (GitHub: Anastasia-genetics, email:shnirevaa@mail.ru)

Елена Платонова, врач-кардиолог (GitHub: Plat9ev, email:drplatosha@gmail.com)

Виталий Хижа, врач (GitHub: KhizhaVitaly, email:)

Все авторы внесли равнозначный вклад в проект.
